<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utflyktsroulett i Sk√•ne</title>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TDK4KHB7');</script>
    <!-- End Google Tag Manager -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle diagonal gradient background for more depth */
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ed 100%); 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #2d3748; /* Default text color */
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            text-align: center;
            max-width: 600px;
            width: 100%;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        #rouletteDisplay {
            min-height: 180px; /* Increased to accommodate train animation and text */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 25px; /* Adjusted padding */
            background-color: #edf2f7; /* Slightly darker background for display */
            border-radius: 18px; /* Rounded corners for display area */
            border: 1px dashed #cbd5e1; /* Dashed border for visual interest */
            transition: background-color 0.4s ease; /* Smoother transition */
            overflow: hidden; /* Hide overflowing content during animation */
        }
        #rouletteDisplay.spinning {
            background-color: #ffe8d6; /* Light orange during spin */
            border-color: #fbd38d; /* Orange dashed border */
        }
        #destination {
            font-size: 2.25rem; /* Larger font for destination */
            font-weight: 700; /* Bold */
            color: #2d3748; /* Darker text */
            margin-bottom: 10px;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* Faster transitions for spin effect */
            will-change: transform, opacity; /* Optimize for animation */
        }
        #activity {
            font-size: 1.15rem; /* Readable font for activity */
            color: #4a5568; /* Slightly lighter text */
            line-height: 1.6;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* Faster transitions for spin effect */
            will-change: transform, opacity; /* Optimize for animation */
        }
        #weatherInfo {
            font-size: 1rem;
            color: #4a5568;
            margin-top: 5px;
            line-height: 1.4;
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center; /* Vertically align icon and text */
            gap: 8px; /* Space between icon and text */
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
            will-change: transform, opacity;
            overflow: hidden; /* Add this to clip content that overflows */
            justify-content: center; /* Center content within weatherInfo div */
        }
        #weatherIconEmoji { /* Changed from #weatherIcon to #weatherIconEmoji */
            font-size: 24px; /* Size for emoji icon */
            line-height: 1;
        }
        #weatherText {
            white-space: nowrap; /* Prevent text from wrapping */
        }
        #trainTimes {
            font-size: 0.95rem;
            color: #6a0dad; /* Matching purple */
            margin-top: 15px;
            text-align: left;
            width: 100%;
            max-width: 300px; /* Align with select box max-width */
            line-height: 1.4;
        }
        #trainTimes ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #trainTimes li {
            background-color: #f7fafc;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            border: 1px solid #ebf4ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        button {
            background-color: #6a0dad; /* Deeper, richer purple */
            color: white;
            padding: 15px 30px;
            border-radius: 10px; /* Rounded button */
            font-size: 1.25rem; /* Larger button text */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 6px 18px rgba(106, 13, 173, 0.4); /* Soft shadow with purple tint */
        }
        button:hover {
            background-color: #7d26da; /* Lighter purple on hover */
            transform: translateY(-3px); /* Slight lift */
            box-shadow: 0 10px 25px rgba(106, 13, 173, 0.5);
        }
        button:active {
            transform: translateY(0); /* Press effect */
            box-shadow: 0 4px 12px rgba(106, 13, 173, 0.3);
        }
        button:disabled {
            background-color: #a0aec0; /* Grey when disabled */
            cursor: not-allowed;
            box-shadow: none;
            transform: none; /* No lift when disabled */
        }
        select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background-color: white;
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
            appearance: none; /* Remove default dropdown arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.6-3.6-8.5-5.4-13.9-5.4s-10.3%2C1.8-13.9%2C5.4L5.4%2C197.3c-3.6%2C3.6-5.4%2C8.5-5.4%2C13.9s1.8%2C10.3%2C5.4%2C13.9l13.9%2C13.9c3.6%2C3.6%2C8.5%2C5.4%2C13.9%2C5.4s10.3-1.8%2C13.9-5.4l92.5-92.5l92.5%2C92.5c3.6%2C3.6%2C8.5%2C5.4%2C13.9%2C5.4s10.3-1.8%2C13.9-5.4l13.9-13.9c3.6-3.6%2C5.4-8.5%2C5.4-13.9s-1.8-10.3-5.4-13.9z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
        }

        /* Train animation specific styles */
        #train-animation-container {
            height: 40px; /* Increased height for larger train */
            width: 100%;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Hidden by default class */
        .hidden {
            display: none;
        }

        /* Keyframes for train movement */
        @keyframes trainMovement {
            0% { transform: translateX(-40px); } /* Start slightly off-screen left */
            50% { transform: translateX(calc(100% + 10px)); } /* Move across to right edge */
            100% { transform: translateX(-40px); } /* Reset for continuous loop */
        }
        
        #train {
            animation: trainMovement 1.5s linear infinite; /* Faster, continuous loop */
            animation-play-state: paused; /* Paused by default */
            transform-origin: center center;
        }

        .summer-ticket-link {
            display: block;
            margin-top: 20px;
            font-size: 0.95rem; /* Slightly larger font */
            color: #6a0dad; /* Matching the button's purple */
            text-decoration: underline;
            font-weight: 500;
        }
        .summer-ticket-link:hover {
            color: #7d26da; /* Lighter purple on hover */
        }

        /* Modal specific styles */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }

        /* Spinner for loading indicator */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6a0dad; /* Purple spinner */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-top: 10px; /* Space below text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TDK4KHB7"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Utflyktsroulett i Sk√•ne</h1>
        <p class="text-gray-600 mb-4">V√§lj din startort och hitta din n√§sta t√•gresa med aktivitet!</p>

        <label for="startCity" class="block text-gray-700 text-sm font-semibold mb-2">V√§lj startort:</label>
        <select id="startCity" class="mb-8">
            <!-- Options will be dynamically populated here by JavaScript -->
        </select>

        <div id="rouletteDisplay" class="mb-8">
            <!-- Loading Indicator for Geolocation -->
            <div id="loadingIndicator" class="flex flex-col items-center justify-center hidden">
                <p id="loadingText" class="text-xl font-semibold text-gray-700 mb-2">Hittar din position...</p>
                <div class="spinner"></div>
            </div>

            <!-- Train animation container -->
            <div id="train-animation-container" class="hidden">
                <svg width="100%" height="40" viewBox="0 0 200 40" preserveAspectRatio="xMidYMid meet">
                    <!-- Track -->
                    <line x1="0" y1="20" x2="200" y2="20" stroke="#a0aec0" stroke-width="4" stroke-linecap="round"/>
                    <!-- Train (grouped for animation) -->
                    <g id="train">
                        <!-- Locomotive Body -->
                        <rect x="0" y="5" width="40" height="25" rx="5" ry="5" fill="#6a0dad"/>
                        <!-- Cab -->
                        <rect x="30" y="0" width="10" height="15" rx="3" ry="3" fill="#4a077d"/>
                        <!-- Smoke Stack -->
                        <rect x="5" y="0" width="8" height="8" rx="2" ry="2" fill="#4a5568"/>
                        <!-- Wheels -->
                        <circle cx="10" cy="30" r="5" fill="#333"/>
                        <circle cx="30" cy="30" r="5" fill="#333"/>
                        <!-- Connecting Rods (simple lines) -->
                        <line x1="10" y1="30" x2="30" y1="30" stroke="#555" stroke-width="2"/>
                    </g>
                </svg>
            </div>
            <p id="destination" class="text-gray-900 text-4xl font-extrabold"></p>
            <p id="activity" class="text-gray-700 text-lg"></p>
            <div id="weatherInfo" class="hidden">
                <span id="weatherIconEmoji"></span> <!-- Changed from img to span -->
                <span id="weatherText" class="text-gray-700"></span>
            </div>
            <div id="trainTimes" class="hidden">
                <h3 class="text-lg font-semibold mb-2">N√§stkommande t√•gtider:</h3>
                <ul id="trainTimesList">
                    <!-- Train times will be populated here by JavaScript -->
                </ul>
            </div>
        </div>

        <button id="spinButton">Slumpa min resa</button>

        <a href="https://www.skanetrafiken.se/aktuellt/sommarbiljetten/" target="_blank" class="summer-ticket-link">K√∂p Sommarbiljetten h√§r!</a>
    </div>

    <script>
        // Data f√∂r alla st√§der i Sk√•ne med f√∂rslag p√• aktiviteter och koordinater
        // stationId √§r satt till null f√∂r st√§der som inte har ett h√•rdkodat ID √§n.
        const allCitiesData = {
            "Malm√∂": { name: "Malm√∂", activity: "Utforska Malm√∂hus Slott, njut av en b√•ttur p√• kanalerna ('Rundan') eller bes√∂k Disgusting Food Museum f√∂r en annorl√•nda upplevelse.", lat: 55.605, lon: 13.002, stationId: "740000003" }, 
            "Lund": { name: "Lund", activity: "Uppt√§ck Lunds Domkyrka, promenera i Botaniska tr√§dg√•rden eller bes√∂k Kulturen, ett friluftsmuseum.", lat: 55.7047, lon: 13.191, stationId: "740000120" }, 
            "Helsingborg": { name: "Helsingborg", activity: "Kl√§ttra upp i K√§rnan f√∂r panoramautsikt, bes√∂k Sofiero Slott och Slottstr√§dg√•rd, eller koppla av p√• Tropical Beach.", lat: 56.0465, lon: 12.6946, stationId: "740000044" }, 
            "Esl√∂v": { name: "Esl√∂v", activity: "Bes√∂k Karlsrobadet f√∂r ett √§ventyr i simhallen eller utforska discgolfbanan i Trollsj√∂omr√•det.", lat: 55.8392, lon: 13.3039, stationId: "740000260" }, 
            "H√§ssleholm": { name: "H√§ssleholm", activity: "Bes√∂k Wan√•s Konstpark f√∂r unik konst i naturen (kolla bussf√∂rbindelser), utforska H√§ssleholms historia p√• museet, eller ta en utflykt till Hovdala Slott.", lat: 56.1667, lon: 13.7833, stationId: "740000006" },
            "Kristianstad": { name: "Kristianstad", activity: "L√§r dig om regionens historia p√• Regionmuseet, beundra den vackra Heliga Trefaldighetskyrkan, eller upplev det unika biosf√§romr√•det Vattenriket p√• Naturum.", lat: 56.0294, lon: 14.1593, stationId: "740000200" }, 
            "Ystad": { name: "Ystad", activity: "Vandra genom Ystads pitoreska Gamla Stan, bes√∂k Klostret, eller f√∂lj med p√• en guidad tur i Wallanders fotsp√•r.", lat: 55.42, lon: 13.83, stationId: "740000028" }, 
            "Trelleborg": { name: "Trelleborg", activity: "Uppt√§ck den rekonstruerade vikingaborgen Trelleborgen, bes√∂k Axel Ebbes Konsthall, eller strosa runt i stadsk√§rnan.", lat: 55.37, lon: 13.16, stationId: "740000088" }, 
            "H√∂√∂r": { name: "H√∂√∂r", activity: "Tillbringa en dag p√• Sk√•nes Djurpark, bes√∂k det vackra Bosj√∂kloster Slott, eller njut av naturen vid Ringsj√∂n med bad eller fiske.", lat: 55.9361, lon: 13.5472, stationId: "740000185" },
            "Stehag": { name: "Stehag", activity: "Ta ett svalkande dopp vid Sj√∂holmens badplats (vid Ringsj√∂n), eller vandra/springa i Gyaskogens motionssp√•r.", lat: 55.900, lon: 13.383, stationId: "740000952" }, 
            "Klippan": { name: "Klippan", activity: "Vandra i det vackra naturreservatet Kl√∂va Hallar, handla kvalitetsullullprodukter p√• Klippans Yllefabrik, eller cykla dressin p√• den gamla j√§rnv√§gen.", lat: 56.1333, lon: 13.1333, stationId: "740000121" }, 
            "Teckomatorp": { name: "Teckomatorp", activity: "Utforska Torvalla och dess faciliteter, eller ge dig ut p√• en cykeltur p√• de omkringliggande landv√§garna.", lat: 55.867, lon: 13.09, stationId: "740000011" }, 
            "Landskrona": { name: "Landskrona", activity: "Bes√∂k den v√§lbevarade f√§stningen Landskrona Citadell, ta en f√§rja √∂ver till √∂n Ven f√∂r en cykeltur, eller utforska konst p√• Konsthallen.", lat: 55.8706, lon: 12.8256, stationId: "740001554" },
            "Simrishamn": { name: "Simrishamn", activity: "Bes√∂k St. Nicolai Kyrka, strosa runt i den mysiga hamnen, eller utforska √ñsterlens vackra landskap.", lat: 55.55, lon: 14.35, stationId: "740000169" }, 
            "√Östorp": { name: "√Östorp", activity: "Bes√∂k S√∂der√•sens nationalpark (kr√§ver ev. bussbyte) eller utforska den gamla bruksorten.", lat: 56.1347, lon: 12.9472, stationId: "740000155" }, 
            "√Ñngelholm": { name: "√Ñngelholm", activity: "Strosa l√§ngs R√∂nne √•, bes√∂k J√§rnv√§gsmuseet eller koppla av p√• den l√•nga sandstranden i Sibirien.", lat: 56.2417, lon: 12.9261, stationId: "740000064" }, 
            "Bjuv": { name: "Bjuv", activity: "Uppt√§ck Bjuvs historia vid det gamla bruksomr√•det eller njut av lugnet i naturen runtomkring.", lat: 56.0833, lon: 12.9167, stationId: "740000102" }, 
            "K√§vlinge": { name: "K√§vlinge", activity: "Cykla l√§ngs K√§vlinge√•n, bes√∂k vackra K√§vlinge kyrka, eller utforska de lokala g√•rdsbutikerna.", lat: 55.7939, lon: 13.1133, stationId: "740000945" }, 
            "Burl√∂v": { name: "Burl√∂v", activity: "Shoppa p√• Burl√∂v Center, eller ta en promenad i Arl√∂vs gr√∂nomr√•den.", lat: 55.6333, lon: 13.0667, stationId: "740000937" }, 
            "Lomma": { name: "Lomma", activity: "Njut av stranden i Lomma Hamn, ta en fika vid vattnet, eller promenera l√§ngs strandpromenaden.", lat: 55.6667, lon: 13.0833, stationId: "740013359" }, 
            "Svedala": { name: "Svedala", activity: "Uppt√§ck Svedala kyrka, eller njut av en lugn promenad i Svedalaparken.", lat: 55.5, lon: 13.2333, stationId: "740000397" }, 
            "Tomelilla": { name: "Tomelilla", activity: "Bes√∂k Tosselilla Sommarland (s√§songs√∂ppet), utforska Fyledalen, eller upplev √ñsterlen lyser (h√∂sts√§song).", lat: 55.5472, lon: 13.9472, stationId: "740000323" }, 
            "Brom√∂lla": { name: "Brom√∂lla", activity: "Bes√∂k If√∂ Center f√∂r konst och kultur, eller utforska Iv√∂sj√∂n med bad- och fiskem√∂jligheter.", lat: 56.05, lon: 14.4667, stationId: "740098046" }, 
            "Osby": { name: "Osby", activity: "Njut av naturen runt Osbysj√∂n, eller bes√∂k Brio Lekoseum.", lat: 56.3667, lon: 13.9833, stationId: "740000295" },
            "Perstorp": { name: "Perstorp", activity: "Utforska den unika Perstorpsparken med dess skulpturer och gr√∂nomr√•den.", lat: 56.1333, lon: 13.3833, stationId: "740000022" }, 
            "Sval√∂v": { name: "Sval√∂v", activity: "Bes√∂k Sval√∂vs bibliotek, eller utforska de lokala cykellederna i det vackra jordbrukslandskapet.", lat: 55.9142, lon: 13.1044, stationId: "740012207" }, 
            "Bark√•kra": { name: "Bark√•kra", activity: "Uppt√§ck den charmiga omgivningen och njut av naturen n√§ra stationen.", lat: 56.2995, lon: 12.8718, stationId: "740001613" }, 
            "Billeberga": { name: "Billeberga", activity: "Upplev det sk√•nska jordbrukslandskapet och den lokala bygden.", lat: 55.8016, lon: 12.9912, stationId: "740000934" }, 
            "B√•stad": { name: "B√•stad", activity: "Bes√∂k tennisstadion, hamnen eller den vackra strandpromenaden.", lat: 56.4357, lon: 12.8300, stationId: "740001603" },
            "Fj√§lkinge": { name: "Fj√§lkinge", activity: "Utforska den lokala bygden och historiska platser i n√§rheten.", lat: 56.0461, lon: 14.2880, stationId: "740001607" }, 
            "Furulund": { name: "Furulund", activity: "Promenera l√§ngs K√§vlinge√•n eller uppt√§ck den lokala naturen.", lat: 55.7599, lon: 13.0487, stationId: "740016624" }, 
            "Gantofta": { name: "Gantofta", activity: "Njut av de gr√∂na omr√•dena och den lugna atmosfisomhet i byn.", lat: 55.9868, lon: 12.8706, stationId: "740001555" }, 
            "Glumsl√∂v": { name: "Glumsl√∂v", activity: "Njut av utsikten √∂ver √ñresund och de b√∂ljande f√§lten.", lat: 55.9328, lon: 12.8647, stationId: "740001558" }, 
            "Gunnesbo": { name: "Gunnesbo", activity: "Perfekt f√∂r att n√• de norra delarna av Lund och dess universitetsomr√•de.", lat: 55.7275, lon: 13.1793, stationId: "740000941" }, 
            "G√§rsn√§s": { name: "G√§rsn√§s", activity: "En liten ort p√• √ñsterlen, k√§nd f√∂r sin m√∂belindustri och charmiga omgivningar.", lat: 55.5398, lon: 14.1685, stationId: "740000742" }, 
            "Hj√§rup": { name: "Hj√§rup", activity: "Upplev sm√•stadscharmen och det vackra landskapet mellan Malm√∂ och Lund.", lat: 55.6791, lon: 13.0805, stationId: "740000942" }, 
            "Hyllie": { name: "Hyllie", activity: "Bes√∂k Emporia k√∂pcentrum eller Malm√∂ Arena, enkelt att n√• evenemang.", lat: 55.5684, lon: 12.9839, stationId: "740001586" }, 
            "Killeberg": { name: "Killeberg", activity: "En lugn plats i norra Sk√•ne, n√§ra till sj√∂ar och skogar.", lat: 56.4172, lon: 13.9880, stationId: "740001605" }, 
            "Klosterg√•rden": { name: "Klosterg√•rden", activity: "Utforska gr√∂nomr√•dena och sportanl√§ggningarna i n√§romr√•det.", lat: 55.6888, lon: 13.1819, stationId: "740001375" }, 
            "Kvidinge": { name: "Kvidinge", activity: "Utforska den historiska bygden och naturomr√•dena runt R√∂nne √•.", lat: 56.1264, lon: 13.0610, stationId: "740001610" }, 
            "K√∂pingebro": { name: "K√∂pingebro", activity: "En liten ort n√§ra Ystad, med charmiga bymilj√∂er och omgivande natur.", lat: 55.4223, lon: 13.9015, stationId: "740000946" }, 
            "Lunnarp": { name: "Lunnarp", activity: "Ett jordbrukslandskap med sm√• byar, perfekt f√∂r cykelturer.", lat: 55.5186, lon: 13.9893, stationId: "740001234" }, 
            "Maria": { name: "Maria", activity: "Ligger n√§ra sjukhuset och bostadsomr√•den i Helsingborg, en bra utg√•ngspunkt f√∂r stadens norra delar.", lat: 56.0664, lon: 12.7937, stationId: "740001542" }, 
            "Marieholm": { name: "Marieholm", activity: "Uppt√§ck den lokala historien och de gr√∂na omgivningarna.", lat: 55.8202, lon: 13.0763, stationId: "74001616" }, 
            "M√∂rarp": { name: "M√∂rarp", activity: "En lugn by med n√§rhet till Helsingborg och vacker natur.", lat: 55.9928, lon: 12.8906, stationId: "740011104" }, 
            "Oxie": { name: "Oxie", activity: "En lugn f√∂rort till Malm√∂ med n√§rhet till b√•de natur och stadsliv.", lat: 55.5492, lon: 13.0906, stationId: "740020760" }, 
            "P√•arp": { name: "P√•arp", activity: "En liten ort norr om Helsingborg, idealisk f√∂r lugna promenader.", lat: 56.0961, lon: 12.7845, stationId: "740000520" }, 
            "Raml√∂sa": { name: "Raml√∂sa", activity: "Bes√∂k den historiska Raml√∂sa Brunnspark med sina k√§llor och vackra omgivningar.", lat: 56.0270, lon: 12.7562, stationId: "740001270" }, 
            "Roseng√•rd": { name: "Roseng√•rd", activity: "Utforska de m√•ngkulturella kvarteren och dess unika atmosf√§r i Malm√∂.", lat: 55.5891, lon: 13.0305, stationId: "740001621" }, 
            "Rydsg√•rd": { name: "Rydsg√•rd", activity: "En liten ort med jordbrukslandskap, perfekt f√∂r lugna promenader.", lat: 55.4800, lon: 13.4300, stationId: "740000415" }, 
            "Rydeb√§ck": { name: "Rydeb√§ck", activity: "Kustn√§ra omr√•de med fin strand och utsikt √∂ver √ñresund.", lat: 55.9400, lon: 12.7500, stationId: "740001557" }, 
            "Skurup": { name: "Skurup", activity: "Bes√∂k Skurups folkh√∂gskola eller uppt√§ck den lokala landsbygden.", lat: 55.4819, lon: 13.5681, stationId: "740000138" }, 
            "Smedstorp": { name: "Smedstorp", activity: "En liten by p√• √ñsterlen med konst och hantverk i fokus.", lat: 55.5306, lon: 14.1083, stationId: "740001307" }, 
            "St√•ngby": { name: "St√•ngby", activity: "Ett lugnt omr√•de norr om Lund, n√§ra till natur och mindre samh√§llen.", lat: 55.7460, lon: 13.1800, stationId: "740000834" }, 
            "Sval√∂v": { name: "Sval√∂v", activity: "Bes√∂k Sval√∂vs bibliotek, eller utforska de lokala cykellederna i det vackra jordbrukslandskapet.", lat: 55.9142, lon: 13.1044, stationId: "740012207" }, 
            "Svarte": { name: "Svarte", activity: "En liten kustort √∂ster om Ystad, med n√§rhet till havet och stranden.", lat: 55.4055, lon: 13.6738, stationId: "740020759" }, 
            "Sv√•gertorp": { name: "Sv√•gertorp", activity: "En knutpunkt f√∂r handel och transport s√∂der om Malm√∂.", lat: 55.5583, lon: 12.9861, stationId: "740001546" }, 
            "S√∂sdala": { name: "S√∂sdala", activity: "N√§ra Finjasj√∂n och dess naturomr√•den, perfekt f√∂r utomhusaktiviteter.", lat: 55.8900, lon: 13.6200, stationId: "740001334" }, 
            "Tj√∂rnarp": { name: "Tj√∂rnarp", activity: "En liten by omgiven av skog och sj√∂ar, perfekt f√∂r avkoppling.", lat: 55.9722, lon: 13.6056, stationId: "740001611" }, 
            "Triangeln": { name: "Triangeln", activity: "Centralt bel√§gen i Malm√∂, med direkt tillg√•ng till shopping och stadsliv.", lat: 55.5925, lon: 13.0039, stationId: "740001588" }, 
            "Tyringe": { name: "Tyringe", activity: "K√§nd f√∂r sitt h√§lsohem, omgiven av vacker natur.", lat: 56.0997, lon: 13.7299, stationId: "740000290" }, 
            "√ñd√•kra": { name: "√ñd√•kra", activity: "En f√∂rort till Helsingborg med bra f√∂rbindelser och gr√∂nomr√•den.", lat: 56.0880, lon: 12.7660, stationId: "740001543" }, 
            "√ñstra Grevie": { name: "√ñstra Grevie", activity: "Utforska den vackra landsbygden runt Vellinge eller bes√∂k lokala g√•rdsbutiker.", lat: 55.5305, lon: 13.0805, stationId: "740001614" } 
        };

        // Skapa stationConnections d√§r varje stad kan n√• alla andra st√§der
        const stationConnections = {};
        const allCityNames = Object.keys(allCitiesData);
        allCityNames.forEach(startCity => {
            stationConnections[startCity] = allCityNames.filter(destCity => destCity !== startCity);
        });

        const API_KEY = "3ecf0515-aa56-46a0-b8b3-6656547bd0e7"; // Din API-nyckel f√∂r Resrobot v2.1
        const TOMORROW_IO_API_KEY = "SUUDE9kQ1exICZsesV1wy1uC3O1AFA5x"; // Din API-nyckel f√∂r Tomorrow.io

        // H√§mta DOM-element och l√§gg till s√§kerhetskontroller
        const spinButton = document.getElementById('spinButton');
        const startCitySelect = document.getElementById('startCity');
        const destinationDisplay = document.getElementById('destination');
        const activityDisplay = document.getElementById('activity');
        const weatherInfoDiv = document.getElementById('weatherInfo'); 
        const weatherIconEmoji = document.getElementById('weatherIconEmoji'); // √Ñndrad till span
        const weatherText = document.getElementById('weatherText');   
        const rouletteDisplayDiv = document.getElementById('rouletteDisplay');
        const trainAnimationContainer = document.getElementById('train-animation-container');
        const trainSVG = document.getElementById('train'); 
        const loadingIndicator = document.getElementById('loadingIndicator'); 
        const loadingText = document.getElementById('loadingText'); 
        const trainTimesDiv = document.getElementById('trainTimes'); 
        const trainTimesList = document.getElementById('trainTimesList'); 

        let currentDestinations = []; 

        // Funktion f√∂r att fylla dropdown-menyn med alla startst√§der
        function populateStartCities() {
            if (!startCitySelect) {
                console.error("populateStartCities: 'startCitySelect' elementet hittades inte.");
                return; 
            }
            const cities = Object.keys(allCitiesData).sort();
            
            startCitySelect.innerHTML = ''; 

            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                startCitySelect.appendChild(option);
            });
        }

        // Uppdatera listan √∂ver destinationer baserat p√• vald startstad
        function updateDestinations() {
            // S√§kerst√§ll att alla element finns innan du forts√§tter
            if (!startCitySelect || !spinButton || !destinationDisplay || !activityDisplay || !weatherInfoDiv || !trainAnimationContainer || !trainSVG || !rouletteDisplayDiv || !loadingIndicator || !loadingText || !trainTimesDiv || !trainTimesList) {
                console.error("updateDestinations: N√•got obligatoriskt DOM-element saknas.");
                return; 
            }

            const selectedStartCity = startCitySelect.value;
            const reachableCityNames = stationConnections[selectedStartCity] || [];

            currentDestinations = reachableCityNames
                .filter(cityName => {
                    const cityData = allCitiesData[cityName];
                    return cityData && cityData.stationId !== null;
                })
                .map(cityName => allCitiesData[cityName]);

            if (allCitiesData[selectedStartCity].stationId === null || currentDestinations.length === 0) {
                spinButton.disabled = true;
                destinationDisplay.textContent = `Kunde inte h√§mta t√•gdata f√∂r ${selectedStartCity} eller inga destinationer hittades.`; 
                activityDisplay.textContent = "V√§lj en annan startort eller f√∂rs√∂k igen senare.";
            } else {
                spinButton.disabled = false;
                destinationDisplay.textContent = "Slumpa min resa!";
                activityDisplay.textContent = "V√§lj din startort och klicka f√∂r att hitta en destination.";
            }
            // Se till att t√•get √§r dolt och texten synlig efter att en ny stad valts
            trainAnimationContainer.classList.add('hidden');
            trainSVG.style.animationPlayState = 'paused'; 
            destinationDisplay.style.display = 'block';
            activityDisplay.style.display = 'block'; // Visa aktivitetstext
            weatherInfoDiv.classList.add('hidden'); // D√∂lj v√§derinfo vid stadsbyte
            weatherInfoDiv.style.display = 'none'; // Se till att den √§r dold
            destinationDisplay.style.opacity = '1';
            activityDisplay.style.opacity = '1';
            rouletteDisplayDiv.classList.remove('spinning');
            loadingIndicator.classList.add('hidden'); 
            loadingText.textContent = "Hittar din position..."; 
            trainTimesDiv.classList.add('hidden'); 
            trainTimesList.innerHTML = ''; 
        }

        // Funktion f√∂r att ber√§kna avst√•ndet mellan tv√• geografiska punkter (Haversine-formeln)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Jordens radie i kilometer
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Avst√•nd i kilometer
        }

        // F√∂rs√∂k att hitta n√§rmaste stad baserat p√• anv√§ndarens plats
        function findNearestCity(latitude, longitude) {
            let closestCityName = '';
            let minDistance = Infinity;

            const citiesWithStationIds = Object.keys(allCitiesData).filter(cityName => allCitiesData[cityName].stationId !== null);

            if (citiesWithStationIds.length === 0) {
                console.warn("Inga st√§der med giltiga stations-ID att j√§mf√∂ra med f√∂r geolokalisering.");
                return null; 
            }

            for (const cityName of citiesWithStationIds) {
                const city = allCitiesData[cityName];
                const distance = haversineDistance(latitude, longitude, city.lat, city.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestCityName = cityName;
                }
            }
            return closestCityName;
        }

        /**
         * H√§mtar stations-ID f√∂r alla st√§der fr√•n Resrobots API med location.name endpoint.
         * Uppdaterar allCitiesData-objektet med stationId.
         * @returns {Promise<void>} Resolves n√§r alla ID har behandlats.
         */
        function fetchAllStationIds() {
            const cityNames = Object.keys(allCitiesData);
            const fetchPromises = cityNames.map(cityName => {
                const city = allCitiesData[cityName];
                if (city.stationId !== null && city.stationId !== undefined) { 
                    return Promise.resolve(); // Returnera en redan l√∂st Promise om ID finns
                }
                
                return fetch(`https://api.resrobot.se/v2.1/location.name?input=${encodeURIComponent(cityName)}&format=json&accessId=${API_KEY}`)
                    .then(response => {
                        if (!response.ok) {
                            console.warn(`HTTP error fetching stationId for ${cityName}: ${response.status}`);
                            return null; // Returnera null f√∂r att indikera att inget ID hittades/fel
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.StopLocation && data.StopLocation.length > 0) {
                            const exactMatch = data.StopLocation.find(sl => 
                                sl.name.toLowerCase().includes(cityName.toLowerCase()) && 
                                (sl.type === 'station' || sl.type === 'stop')
                            );
                            if (exactMatch) {
                                city.stationId = exactMatch.id;
                            } else {
                                const firstRelevant = data.StopLocation.find(sl => sl.type === 'station' || sl.type === 'stop') || data.StopLocation[0];
                                city.stationId = firstRelevant.id;
                                console.warn(`Ingen exakt stationsmatch f√∂r ${cityName}, anv√§nder f√∂rsta relevanta: ${firstRelevant.name || firstRelevant.id}`);
                            }
                        } else {
                            console.warn(`Kunde inte hitta stationId f√∂r ${cityName}. Exkluderar denna ort fr√•n API-s√∂kningar.`);
                            city.stationId = null; 
                        }
                    })
                    .catch(error => {
                        console.error(`Fel vid h√§mtning av stationId f√∂r ${cityName}:`, error);
                        city.stationId = null; 
                    });
            });
            return Promise.all(fetchPromises); // V√§nta p√• att alla Promise har l√∂sts
        }

        /**
         * H√§mtar verkliga t√•gtider mellan tv√• st√§der med Resrobots API.
         * @param {string} startCityName Namnet p√• startstaden.
         * @param {string} destinationCityName Namnet p√• destinationsstaden.
         * @returns {Promise<string[]>} En array av str√§ngar som representerar kommande t√•gtider.
         */
        function fetchTrainTimes(startCityName, destinationCityName) {
            const originStationId = allCitiesData[startCityName]?.stationId || null;
            const destinationStationId = allCitiesData[destinationCityName]?.stationId || null;

            if (!originStationId) {
                console.error(`ERROR: originStationId saknas f√∂r ${startCityName}. Data:`, allCitiesData[startCityName]);
                return Promise.resolve([`Kunde inte h√§mta t√•gtider (Startort '${startCityName}' saknar stationsdata).`]);
            }
            if (!destinationStationId) {
                console.error(`ERROR: destinationStationId saknas f√∂r ${destinationCityName}. Data:`, allCitiesData[destinationCityName]);
                return Promise.resolve([`Kunde inte h√§mta t√•gtider (Destination '${destinationCityName}' saknar stationsdata).`]);
            }

            const apiUrl = `https://api.resrobot.se/v2.1/trip?format=json&originId=${originStationId}&destId=${destinationStationId}&passlist=true&showPassingPoints=true&maxJourneys=3&accessId=${API_KEY}`;
            
            console.log("API-anrop URL:", apiUrl);

            return fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        console.error(`API URL som misslyckades: ${apiUrl}`);
                        throw new Error(`HTTP-fel! status: ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Hela API-svaret:", data);
                    const times = [];
                    if (data.Trip && data.Trip.length > 0) {
                        for (let i = 0; i < data.Trip.length; i++) {
                            const trip = data.Trip[i];
                            
                            // Defensive checks for leg objects and their origin/destination properties
                            if (!trip.LegList || !trip.LegList.Leg || trip.LegList.Leg.length === 0) {
                                console.warn("Skipping trip due to incomplete leg data (missing LegList or empty Leg array):", trip);
                                continue; 
                            }

                            const firstLeg = trip.LegList.Leg[0];
                            const lastLeg = trip.LegList.Leg[trip.LegList.Leg.length - 1]; 

                            if (!firstLeg || !firstLeg.Origin || !lastLeg || !lastLeg.Destination) {
                                console.warn("Skipping trip due to missing origin/destination data in leg:", trip);
                                continue; 
                            }

                            let schedOriginDateTime, schedDestDateTime, effectiveOriginDateTime, effectiveDestDateTime;

                            try {
                                const schedOriginDateTimeStr = `${firstLeg.Origin.date}T${firstLeg.Origin.time}`;
                                const schedDestDateTimeStr = `${lastLeg.Destination.date}T${lastLeg.Destination.time}`;

                                schedOriginDateTime = new Date(schedOriginDateTimeStr);
                                schedDestDateTime = new Date(schedDestDateTimeStr);
                                
                                if (isNaN(schedOriginDateTime.getTime()) || isNaN(schedDestDateTime.getTime())) {
                                    console.warn("Skipping trip due to invalid scheduled date/time string:", schedOriginDateTimeStr, schedDestDateTimeStr);
                                    continue;
                                }

                                const effectiveOriginDate = firstLeg.Origin.rtDate || firstLeg.Origin.date;
                                const effectiveOriginTime = firstLeg.Origin.rtTime || firstLeg.Origin.time;
                                const effectiveDestDate = lastLeg.Destination.rtDate || lastLeg.Destination.date;
                                const effectiveDestTime = lastLeg.Destination.rtTime || lastLeg.Destination.time;

                                const effectiveOriginDateTimeStr = `${effectiveOriginDate}T${effectiveOriginTime}`;
                                const effectiveDestDateTimeStr = `${effectiveDestDate}T${effectiveDestTime}`;

                                effectiveOriginDateTime = new Date(effectiveOriginDateTimeStr);
                                effectiveDestDateTime = new Date(effectiveDestDateTimeStr);

                                if (isNaN(effectiveOriginDateTime.getTime()) || isNaN(effectiveDestDateTime.getTime())) {
                                    console.warn("Skipping trip due to invalid effective date/time string:", effectiveOriginDateTimeStr, effectiveDestDateTimeStr);
                                    continue;
                                }
                            } catch (e) {
                                console.error("Error creating Date objects for trip, skipping:", e, trip);
                                continue; 
                            }

                            const depFormatted = effectiveOriginDateTime.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                            const arrFormatted = effectiveDestDateTime.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });

                            let depStatusText = '';
                            let arrStatusText = '';
                            let hasDeviation = false; 

                            if (effectiveOriginDateTime.getTime() > schedOriginDateTime.getTime() + 60000) { 
                                depStatusText = '(f√∂rsenad)';
                                hasDeviation = true;
                            } else if (effectiveOriginDateTime.getTime() < schedOriginDateTime.getTime() - 60000) { 
                                depStatusText = '(tidig)';
                                hasDeviation = true;
                            } 

                            if (effectiveDestDateTime.getTime() > schedDestDateTime.getTime() + 60000) { 
                                arrStatusText = '(f√∂rsenad)';
                                hasDeviation = true;
                            } else if (effectiveDestDateTime.getTime() < schedDestDateTime.getTime() - 60000) { 
                                arrStatusText = '(tidig)';
                                hasDeviation = true;
                            } 

                            let formattedTimeString = `Avg√•r: ${depFormatted} ${depStatusText} (${startCityName}) - Ankommer: ${arrFormatted} ${arrStatusText} (${destinationCityName})`;
                            
                            if (hasDeviation) {
                                formattedTimeString += " (OBS: Avvikelse!)";
                            }

                            times.push(formattedTimeString);
                            console.log("Formaterad t√•gtid f√∂r display:", formattedTimeString); 
                        }
                    } else {
                        times.push("Inga t√•gtider hittades f√∂r denna str√§cka just nu.");
                    }
                    return times;
                })
                .catch(error => {
                    console.error("Fel vid h√§mtning av t√•gtider fr√•n Resrobot API:", error);
                    return [`Kunde inte h√§mta t√•gtider (API-fel: ${error.message}). Kontrollera konsolen f√∂r mer information.`];
                });
        }

        // Mappning f√∂r Tomorrow.io v√§derkoder till beskrivningar och emojis
        const weatherCodeMap = {
            1000: { description: "Klart", emoji: "‚òÄÔ∏è" },
            1100: { description: "Mestadels klart", emoji: "üå§Ô∏è" },
            1101: { description: "Delvis molnigt", emoji: "‚õÖ" },
            1102: { description: "Mestadels molnigt", emoji: "&#x2601;" }, // Changed to basic cloud symbol
            1001: { description: "Molnigt", emoji: "&#x2601;" }, // Changed to basic cloud symbol
            2000: { description: "Dimma", emoji: "üå´Ô∏è" },
            2100: { description: "L√§tt dimma", emoji: "üå´Ô∏è" },
            3000: { description: "L√§tt vind", emoji: "üí®" },
            3001: { description: "Vindigt", emoji: "üå¨Ô∏è" },
            3002: { description: "Stark vind", emoji: "üå¨Ô∏è" },
            4000: { description: "Duggregn", emoji: "üåßÔ∏è" },
            4001: { description: "Regn", emoji: "üåßÔ∏è" },
            4200: { description: "L√§tt regn", emoji: "ÔøΩÔ∏è" },
            4201: { description: "Kraftigt regn", emoji: "‚õàÔ∏è" },
            5000: { description: "Sn√∂", emoji: "‚ùÑÔ∏è" },
            5001: { description: "Sn√∂byar", emoji: "üå®Ô∏è" },
            5100: { description: "L√§tt sn√∂fall", emoji: "üå®Ô∏è" },
            5101: { description: "Kraftigt sn√∂fall", emoji: "üå®Ô∏è" },
            6000: { description: "Underkylt duggregn", emoji: "üßäüåßÔ∏è" },
            6001: { description: "Underkylt regn", emoji: "üßäüåßÔ∏è" },
            6200: { description: "L√§tt underkylt regn", emoji: "üßäüåßÔ∏è" },
            6201: { description: "Kraftigt underkylt regn", emoji: "üßä‚õàÔ∏è" },
            7000: { description: "Isregn", emoji: "üå®Ô∏è" },
            7101: { description: "Kraftigt isregn", emoji: "üå®Ô∏è" },
            7102: { description: "L√§tt isregn", emoji: "üå®Ô∏è" },
            8000: { description: "√Öskv√§der", emoji: "üå©Ô∏è" },
            default: { description: "Ok√§nt v√§der", emoji: "‚ùì" }
        };

        /**
         * H√§mtar aktuell v√§derdata f√∂r givna koordinater med Tomorrow.io API.
         * @param {number} lat Latitud f√∂r platsen.
         * @param {number} lon Longitud f√∂r platsen.
         * @returns {Promise<{temp: number, description: string, emoji: string}|null>} V√§derdata eller null vid fel.
         */
        function fetchWeatherData(lat, lon) {
            if (!TOMORROW_IO_API_KEY) { 
                console.warn("Tomorrow.io API Key saknas eller √§r inte inst√§lld. V√§derdata kommer inte att h√§mtas.");
                return Promise.resolve(null);
            }

            const weatherApiUrl = `https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&apikey=${TOMORROW_IO_API_KEY}&units=metric&timesteps=1h&fields=temperature,weatherCode`;
            console.log("V√§der API-anrop URL (Tomorrow.io):", weatherApiUrl);

            return fetch(weatherApiUrl)
                .then(response => {
                    if (!response.ok) {
                        console.error(`HTTP error fetching weather data from Tomorrow.io! Status: ${response.status} - ${response.statusText}`);
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("V√§der API-svar (Tomorrow.io):", data);

                    // Kontrollera om data.timelines.hourly finns och har minst ett intervall
                    if (data && data.timelines && data.timelines.hourly && data.timelines.hourly.length > 0) {
                        // Anv√§nd det f√∂rsta intervallet i hourly-arrayen f√∂r aktuell v√§derdata
                        const values = data.timelines.hourly[0].values;
                        const temperature = Math.round(values.temperature);
                        const weatherCode = values.weatherCode;
                        
                        const weatherInfo = weatherCodeMap[weatherCode] || weatherCodeMap.default;

                        return {
                            temp: temperature,
                            description: weatherInfo.description,
                            emoji: weatherInfo.emoji
                        };
                    } else {
                        console.warn("V√§der API-svaret saknar f√∂rv√§ntad 'hourly' data eller 'intervals'.");
                    }
                    return null;
                })
                .catch(error => {
                    console.error("Fel vid h√§mtning av v√§derdata fr√•n Tomorrow.io:", error);
                    return null;
                });
        }

        // Funktion f√∂r att hantera geolokaliseringsresultatet (framg√•ng eller fel)
        function handleGeolocationResult(position) {
            if (!startCitySelect || !destinationDisplay || !activityDisplay) {
                console.error("handleGeolocationResult: N√•got obligatoriskt DOM-element saknas.");
                return; 
            }
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const nearestCity = findNearestCity(userLat, userLon);

            if (nearestCity && allCitiesData[nearestCity] && allCitiesData[nearestCity].stationId !== null) {
                startCitySelect.value = nearestCity;
                destinationDisplay.textContent = "Din n√§rmaste stad √§r:";
                activityDisplay.textContent = nearestCity + " (valt automatiskt)";
            } else {
                startCitySelect.value = "Malm√∂"; 
                destinationDisplay.textContent = "V√§lj startort!";
                activityDisplay.textContent = "Klicka p√• knappen f√∂r att starta din utflyktsroulett.";
            }
        }

        // Funktion f√∂r att hantera geolokaliseringsfel
        function handleGeolocationError(error) {
            if (!startCitySelect || !destinationDisplay || !activityDisplay) {
                console.error("handleGeolocationError: N√•got obligatoriskt DOM-element saknas.");
                return; 
            }
            console.error("Fel vid h√§mtning av plats: ", error.message || "Ok√§nt fel vid geolokalisering.");
            startCitySelect.value = "Malm√∂"; 
            destinationDisplay.textContent = "V√§lj startort!";
            activityDisplay.textContent = "Klicka p√• knappen f√∂r att starta din utflyktsroulett.";
        }

        document.addEventListener('DOMContentLoaded', function() {
            // S√§kerhetskontroller f√∂r DOM-element
            if (!spinButton || !startCitySelect || !destinationDisplay || !activityDisplay || !weatherInfoDiv || !weatherIconEmoji || !weatherText || !rouletteDisplayDiv || !trainAnimationContainer || !trainSVG || !loadingIndicator || !loadingText || !trainTimesDiv || !trainTimesList) {
                console.error("Kunde inte hitta alla n√∂dv√§ndiga DOM-element vid DOMContentLoaded. Funktionen stoppas.");
                return;
            }

            // Visa laddningsindikator och d√∂lj huvudsinneh√•llet initialt
            loadingIndicator.classList.remove('hidden');
            destinationDisplay.style.display = 'none';
            activityDisplay.style.display = 'none';
            weatherInfoDiv.classList.add('hidden');
            weatherInfoDiv.style.display = 'none';
            trainTimesDiv.classList.add('hidden');
            startCitySelect.disabled = true;
            spinButton.disabled = true;

            let geolocationFinished = false;

            function finalizeLoadProcess() {
                loadingText.textContent = "Laddar t√•gstationsdata...";
                fetchAllStationIds()
                    .then(() => {
                        populateStartCities();
                        loadingIndicator.classList.add('hidden');
                        destinationDisplay.style.display = 'block';
                        activityDisplay.style.display = 'block';
                        startCitySelect.disabled = false;
                        updateDestinations();
                        loadingText.textContent = "Hittar din position...";
                    })
                    .catch(error => {
                        console.error("Fel vid laddning av stationsdata:", error);
                        // Forts√§tt laddning √§ven vid fel f√∂r att undvika att appen l√•ser sig
                        loadingIndicator.classList.add('hidden');
                        destinationDisplay.style.display = 'block';
                        activityDisplay.style.display = 'block';
                        startCitySelect.disabled = false;
                        updateDestinations(); // Uppdatera med eventuella felmeddelanden
                    });
            }

            if (navigator.geolocation) {
                const timeout1 = setTimeout(() => {
                    if (!geolocationFinished) loadingText.textContent = "N√§stan d√§r...";
                }, 5000);
                const timeout2 = setTimeout(() => {
                    if (!geolocationFinished) loadingText.textContent = "Nu g√•r snart t√•get...";
                }, 10000);

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        geolocationFinished = true;
                        clearTimeout(timeout1);
                        clearTimeout(timeout2);
                        handleGeolocationResult(position);
                        finalizeLoadProcess();
                    },
                    function(error) {
                        geolocationFinished = true;
                        clearTimeout(timeout1);
                        clearTimeout(timeout2);
                        handleGeolocationError(error);
                        finalizeLoadProcess();
                    }
                );
            } else {
                console.log("Webbl√§saren st√∂der inte geolokalisering.");
                handleGeolocationError({ message: "Webbl√§saren st√∂der inte geolokalisering." });
                finalizeLoadProcess();
            }
        });

        // Funktion f√∂r att snurra rouletten
        function spinRoulette() { 
            // S√§kerst√§ll att alla element finns innan du forts√§tter
            if (!startCitySelect || !spinButton || !destinationDisplay || !activityDisplay || !weatherInfoDiv || !trainAnimationContainer || !trainSVG || !rouletteDisplayDiv || !trainTimesDiv || !trainTimesList) {
                console.error("Kunde inte hitta alla n√∂dv√§ndiga DOM-element f√∂r att snurra rouletten. Funktionen stoppas.");
                return; 
            }

            const selectedStartCity = startCitySelect.value;
            if (allCitiesData[selectedStartCity].stationId === null || currentDestinations.length === 0) {
                const modal = document.createElement('div');
                modal.className = "modal";
                modal.innerHTML = `
                    <div class="modal-content">
                        <p class="mb-4 text-lg font-semibold text-gray-800">Kunde inte slumpa en resa. V√§nligen v√§lj en startort med tillg√§ngliga destinationer eller en som har f√•tt sin t√•gdata laddad.</p>
                        <button id="closeModal" class="bg-purple-700 text-white px-4 py-2 rounded-md hover:bg-purple-800 transition-colors">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('show'), 10); 
                document.getElementById('closeModal').addEventListener('click', () => {
                    modal.classList.remove('show');
                    setTimeout(() => document.body.removeChild(modal), 300); 
                });
                return;
            }

            spinButton.disabled = true;
            rouletteDisplayDiv.classList.add('spinning');
            trainTimesDiv.classList.add('hidden'); 
            trainTimesList.innerHTML = ''; 
            weatherInfoDiv.classList.add('hidden'); 
            weatherInfoDiv.style.display = 'none'; 

            trainAnimationContainer.classList.remove('hidden');
            trainSVG.style.animationPlayState = 'running';

            destinationDisplay.style.display = 'block';
            activityDisplay.style.display = 'none'; 
            destinationDisplay.style.opacity = '0.7'; 
            activityDisplay.style.opacity = '0.7'; 

            let spinCount = 0;
            const totalSpins = 40; 
            const intervalTime = 80; 

            const spinInterval = setInterval(function() {
                const randomIndex = Math.floor(Math.random() * currentDestinations.length);
                const currentSpinningDestination = currentDestinations[randomIndex];

                destinationDisplay.textContent = currentSpinningDestination.name;

                destinationDisplay.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    destinationDisplay.style.transform = 'scale(1)';
                }, intervalTime / 2); 

                spinCount++;
                if (spinCount >= totalSpins) {
                    clearInterval(spinInterval);

                    trainSVG.style.animationPlayState = 'paused';
                    trainAnimationContainer.classList.add('hidden');

                    const finalIndex = Math.floor(Math.random() * currentDestinations.length); 
                    const finalDestination = currentDestinations[finalIndex];

                    destinationDisplay.textContent = finalDestination.name;
                    activityDisplay.textContent = finalDestination.activity; 
                    activityDisplay.style.display = 'block'; 
                    
                    destinationDisplay.style.opacity = '1'; 
                    activityDisplay.style.opacity = '1';

                    destinationDisplay.style.transform = 'scale(0.8)'; 
                    activityDisplay.style.transform = 'scale(0.8)'; 
                    
                    console.log("Anropar fetchWeatherData f√∂r:", finalDestination.name);
                    
                    // Promise chain for weather and train times
                    fetchWeatherData(finalDestination.lat, finalDestination.lon)
                        .then(weatherData => {
                            if (weatherData) {
                                console.log("V√§derdata mottagen, uppdaterar element och visar div.");
                                weatherIconEmoji.innerHTML = weatherData.emoji; // Anv√§nder innerHTML f√∂r att rendera HTML-entiteter
                                weatherText.textContent = `${weatherData.temp}¬∞C, ${weatherData.description}`;
                                
                                // Logga de faktiska v√§rdena som s√§tts
                                console.log(`S√§tter v√§derikon till: ${weatherIconEmoji.innerHTML}`);
                                console.log(`S√§tter v√§dertext till: ${weatherText.textContent}`);

                                weatherInfoDiv.classList.remove('hidden'); 
                                weatherInfoDiv.style.display = 'flex'; 
                                // Ta bort initiala animeringsstilar f√∂r omedelbar visning
                                weatherInfoDiv.style.transform = 'scale(1)'; 
                                weatherInfoDiv.style.opacity = '1';
                            } else {
                                console.log("Ingen v√§derdata mottagen, d√∂ljer v√§derinfo div.");
                                weatherInfoDiv.classList.add('hidden'); 
                                weatherInfoDiv.style.display = 'none'; 
                            }
                            return fetchTrainTimes(selectedStartCity, finalDestination.name);
                        })
                        .then(trainTimes => {
                            console.log("T√•gtider att visa:", trainTimes); 
                            trainTimesList.innerHTML = ''; 
                            if (trainTimes.length > 0 && trainTimes[0] !== "Inga t√•gtider hittades f√∂r denna str√§cka just nu.") { 
                                trainTimes.forEach(time => {
                                    const li = document.createElement('li');
                                    li.textContent = time;
                                    trainTimesList.appendChild(li);
                                });
                                trainTimesDiv.classList.remove('hidden'); 
                            } else {
                                trainTimesList.innerHTML = `<li class="text-gray-500">${trainTimes[0] || "Inga t√•gtider hittades."}</li>`;
                                trainTimesDiv.classList.remove('hidden'); 
                            }
                            spinButton.disabled = false; 

                            // Delayed animation for final display elements - endast f√∂r destination/activity
                            setTimeout(() => { 
                                console.log("Slutlig animation f√∂r destination/aktivitet.");
                                destinationDisplay.style.transform = 'scale(1)'; 
                                activityDisplay.style.transform = 'scale(1)';
                                rouletteDisplayDiv.classList.remove('spinning');
                            }, 300); 
                        })
                        .catch(error => {
                            console.error("Fel i Promise-kedjan f√∂r v√§der/t√•gtider:", error);
                            // Fallback f√∂r att visa felmeddelande eller inaktivera knappen
                            trainTimesList.innerHTML = `<li class="text-gray-500">Kunde inte ladda t√•gtider eller v√§der.</li>`;
                            trainTimesDiv.classList.remove('hidden');
                            spinButton.disabled = false; 
                            setTimeout(() => { 
                                destinationDisplay.style.transform = 'scale(1)'; 
                                activityDisplay.style.transform = 'scale(1)';
                                rouletteDisplayDiv.classList.remove('spinning');
                            }, 300); 
                        });
                }
            }, intervalTime);
        }

        // L√§gg till h√§ndelselyssnare f√∂r dropdown och knapp
        if (startCitySelect) {
            startCitySelect.addEventListener('change', updateDestinations);
        }
        if (spinButton) {
            spinButton.addEventListener('click', spinRoulette);
        }
    </script>
</body>
</html>
ÔøΩ
