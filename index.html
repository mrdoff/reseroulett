<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utflyktsroulett i Skåne</title>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TDK4KHB7');</script>
    <!-- End Google Tag Manager -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle diagonal gradient background for more depth */
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ed 100%); 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #2d3748; /* Default text color */
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            text-align: center;
            max-width: 600px;
            width: 100%;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        #rouletteDisplay {
            min-height: 180px; /* Increased to accommodate train animation and text */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 25px; /* Adjusted padding */
            background-color: #edf2f7; /* Slightly darker background for display */
            border-radius: 18px; /* Rounded corners for display area */
            border: 1px dashed #cbd5e1; /* Dashed border for visual interest */
            transition: background-color 0.4s ease; /* Smoother transition */
            overflow: hidden; /* Hide overflowing content during animation */
        }
        #rouletteDisplay.spinning {
            background-color: #ffe8d6; /* Light orange during spin */
            border-color: #fbd38d; /* Orange dashed border */
        }
        #destination {
            font-size: 2.25rem; /* Larger font for destination */
            font-weight: 700; /* Bold */
            color: #2d3748; /* Darker text */
            margin-bottom: 10px;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* Faster transitions for spin effect */
            will-change: transform, opacity; /* Optimize for animation */
        }
        #activity {
            font-size: 1.15rem; /* Readable font for activity */
            color: #4a5568; /* Slightly lighter text */
            line-height: 1.6;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* Faster transitions for spin effect */
            will-change: transform, opacity; /* Optimize for animation */
        }
        button {
            background-color: #6a0dad; /* Deeper, richer purple */
            color: white;
            padding: 15px 30px;
            border-radius: 10px; /* Rounded button */
            font-size: 1.25rem; /* Larger button text */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 6px 18px rgba(106, 13, 173, 0.4); /* Soft shadow with purple tint */
        }
        button:hover {
            background-color: #7d26da; /* Lighter purple on hover */
            transform: translateY(-3px); /* Slight lift */
            box-shadow: 0 10px 25px rgba(106, 13, 173, 0.5);
        }
        button:active {
            transform: translateY(0); /* Press effect */
            box-shadow: 0 4px 12px rgba(106, 13, 173, 0.3);
        }
        button:disabled {
            background-color: #a0aec0; /* Grey when disabled */
            cursor: not-allowed;
            box-shadow: none;
            transform: none; /* No lift when disabled */
        }
        select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background-color: white;
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
            appearance: none; /* Remove default dropdown arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.6-3.6-8.5-5.4-13.9-5.4s-10.3%2C1.8-13.9%2C5.4L5.4%2C197.3c-3.6%2C3.6-5.4%2C8.5-5.4%2C13.9s1.8%2C10.3%2C5.4%2C13.9l13.9%2C13.9c3.6%2C3.6%2C8.5%2C5.4%2C13.9%2C5.4s10.3-1.8%2C13.9-5.4l92.5-92.5l92.5%2C92.5c3.6%2C3.6%2C8.5%2C5.4%2C13.9%2C5.4s10.3-1.8%2C13.9-5.4l13.9-13.9c3.6-3.6%2C5.4-8.5%2C5.4-13.9s-1.8-10.3-5.4-13.9z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
        }

        /* Train animation specific styles */
        #train-animation-container {
            height: 40px; /* Increased height for larger train */
            width: 100%;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Hidden by default class */
        .hidden {
            display: none;
        }

        /* Keyframes for train movement */
        @keyframes trainMovement {
            0% { transform: translateX(-40px); } /* Start slightly off-screen left */
            50% { transform: translateX(calc(100% + 10px)); } /* Move across to right edge */
            100% { transform: translateX(-40px); } /* Reset for continuous loop */
        }
        
        #train {
            animation: trainMovement 1.5s linear infinite; /* Faster, continuous loop */
            animation-play-state: paused; /* Paused by default */
            transform-origin: center center;
        }

        .summer-ticket-link {
            display: block;
            margin-top: 20px;
            font-size: 0.95rem; /* Slightly larger font */
            color: #6a0dad; /* Matching the button's purple */
            text-decoration: underline;
            font-weight: 500;
        }
        .summer-ticket-link:hover {
            color: #7d26da; /* Lighter purple on hover */
        }

        /* Modal specific styles */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }

        /* Spinner for loading indicator */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6a0dad; /* Purple spinner */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-top: 10px; /* Space below text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TDK4KHB7"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Utflyktsroulett i Skåne</h1>
        <p class="text-gray-600 mb-4">Välj din startort och hitta din nästa tågresa med aktivitet!</p>

        <label for="startCity" class="block text-gray-700 text-sm font-semibold mb-2">Välj startort:</label>
        <select id="startCity" class="mb-8">
            <!-- Options will be dynamically populated here -->
        </select>

        <div id="rouletteDisplay" class="mb-8">
            <!-- Loading Indicator for Geolocation -->
            <div id="loadingIndicator" class="flex flex-col items-center justify-center hidden">
                <p id="loadingText" class="text-xl font-semibold text-gray-700 mb-2">Hittar din position...</p>
                <div class="spinner"></div>
            </div>

            <!-- Train animation container -->
            <div id="train-animation-container" class="hidden">
                <svg width="100%" height="40" viewBox="0 0 200 40" preserveAspectRatio="xMidYMid meet">
                    <!-- Track -->
                    <line x1="0" y1="20" x2="200" y2="20" stroke="#a0aec0" stroke-width="4" stroke-linecap="round"/>
                    <!-- Train (grouped for animation) -->
                    <g id="train">
                        <!-- Locomotive Body -->
                        <rect x="0" y="5" width="40" height="25" rx="5" ry="5" fill="#6a0dad"/>
                        <!-- Cab -->
                        <rect x="30" y="0" width="10" height="15" rx="3" ry="3" fill="#4a077d"/>
                        <!-- Smoke Stack -->
                        <rect x="5" y="0" width="8" height="8" rx="2" ry="2" fill="#4a5568"/>
                        <!-- Wheels -->
                        <circle cx="10" cy="30" r="5" fill="#333"/>
                        <circle cx="30" cy="30" r="5" fill="#333"/>
                        <!-- Connecting Rods (simple lines) -->
                        <line x1="10" y1="30" x2="30" y2="30" stroke="#555" stroke-width="2"/>
                    </g>
                </svg>
            </div>
            <p id="destination" class="text-gray-900 text-4xl font-extrabold"></p>
            <p id="activity" class="text-gray-700 text-lg"></p>
        </div>

        <button id="spinButton">Slumpa min resa</button>

        <a href="https://www.skanetrafiken.se/aktuellt/sommarbiljetten/" target="_blank" class="summer-ticket-link">Köp Sommarbiljetten här!</a>
    </div>

    <script>
        // Data for all cities in Skåne with their activity suggestions and coordinates
        // This list exclusively contains locations with train stations in Skåne.
        const allCitiesData = {
            "Malmö": { name: "Malmö", activity: "Utforska Malmöhus Slott, njut av en båttur på kanalerna ('Rundan') eller besök Disgusting Food Museum för en annorlånda upplevelse.", lat: 55.605, lon: 13.002 },
            "Lund": { name: "Lund", activity: "Upptäck Lunds Domkyrka, promenera i Botaniska trädgården eller besök Kulturen, ett friluftsmuseum.", lat: 55.7047, lon: 13.191 },
            "Helsingborg": { name: "Helsingborg", activity: "Klättra upp i Kärnan för panoramautsikt, besök Sofiero Slott och Slottsträdgård, eller koppla av på Tropical Beach.", lat: 56.0465, lon: 12.6946 },
            "Eslöv": { name: "Eslöv", activity: "Besök Karlsrobadet för ett äventyr i simhallen eller utforska discgolfbanan i Trollsjöområdet.", lat: 55.8392, lon: 13.3039 },
            "Hässleholm": { name: "Hässleholm", activity: "Besök Wanås Konstpark för unik konst i naturen (kolla bussförbindelser), utforska Hässleholms historia på museet, eller ta en utflykt till Hovdala Slott.", lat: 56.1667, lon: 13.7833 },
            "Kristianstad": { name: "Kristianstad", activity: "Lär dig om regionens historia på Regionmuseet, beundra den vackra Heliga Trefaldighetskyrkan, eller upplev det unika biosfärområdet Vattenriket på Naturum.", lat: 56.0294, lon: 14.1593 },
            "Ystad": { name: "Ystad", activity: "Vandra genom Ystads pittoreska Gamla Stan, besök Klostret, eller följ med på en guidad tur i Wallanders fotspår.", lat: 55.42, lon: 13.83 },
            "Trelleborg": { name: "Trelleborg", activity: "Upptäck den rekonstruerade vikingaborgen Trelleborgen, besök Axel Ebbes Konsthall, eller strosa runt i stadskärnan.", lat: 55.37, lon: 13.16 },
            "Höör": { name: "Höör", activity: "Tillbringa en dag på Skånes Djurpark, besök det vackra Bosjökloster Slott, eller njut av naturen vid Ringsjön med bad eller fiske.", lat: 55.9361, lon: 13.5472 },
            "Stehag": { name: "Stehag", activity: "Ta ett svalkande dopp vid Sjöholmens badplats (vid Ringsjön), eller vandra/springa i Gyaskogens motionsspår.", lat: 55.900, lon: 13.383 },
            "Klippan": { name: "Klippan", activity: "Vandra i det vackra naturreservatet Klöva Hallar, handla kvalitetsullullprodukter på Klippans Yllefabrik, eller cykla dressin på den gamla järnvägen.", lat: 56.1333, lon: 13.1333 },
            "Teckomatorp": { name: "Teckomatorp", activity: "Utforska Torvalla och dess faciliteter, eller ge dig ut på en cykeltur på de omkringliggande landvägarna.", lat: 55.867, lon: 13.09 },
            "Landskrona": { name: "Landskrona", activity: "Besök den välbevarade fästningen Landskrona Citadell, ta en färja över till ön Ven för en cykeltur, eller utforska konst på Konsthallen.", lat: 55.8706, lon: 12.8256 },
            "Simrishamn": { name: "Simrishamn", activity: "Besök St. Nicolai Kyrka, strosa runt i den mysiga hamnen, eller utforska Österlens vackra landskap.", lat: 55.55, lon: 14.35 },
            "Åstorp": { name: "Åstorp", activity: "Besök Söderåsens nationalpark (kräver ev. bussbyte) eller utforska den gamla bruksorten.", lat: 56.1347, lon: 12.9472 },
            "Ängelholm": { name: "Ängelholm", activity: "Strosa längs Rönne å, besök Järnvägsmuseet eller koppla av på den långa sandstranden i Sibirien.", lat: 56.2417, lon: 12.9261 },
            "Bjuv": { name: "Bjuv", activity: "Upptäck Bjuvs historia vid det gamla bruksområdet eller njut av lugnet i naturen runtomkring.", lat: 56.0833, lon: 12.9167 },
            "Kävlinge": { name: "Kävlinge", activity: "Cykla längs Kävlingeån, besök vackra Kävlinge kyrka, eller utforska de lokala gårdsbutikerna.", lat: 55.7939, lon: 13.1133 },
            "Burlöv": { name: "Burlöv", activity: "Shoppa på Burlöv Center, eller ta en promenad i Arlövs grönområden.", lat: 55.6333, lon: 13.0667 },
            "Lomma": { name: "Lomma", activity: "Njut av stranden i Lomma Hamn, ta en fika vid vattnet, eller promenera längs strandpromenaden.", lat: 55.6667, lon: 13.0833 },
            "Svedala": { name: "Svedala", activity: "Upptäck Svedala kyrka, eller njut av en lugn promenad i Svedalaparken.", lat: 55.5, lon: 13.2333 },
            "Tomelilla": { name: "Tomelilla", activity: "Besök Tosselilla Sommarland (säsongsöppet), utforska Fyledalen, eller upplev Österlen lyser (höstsäsong).", lat: 55.5472, lon: 13.9472 },
            "Bromölla": { name: "Bromölla", activity: "Besök Ifö Center för konst och kultur, eller utforska Ivösjön med bad- och fiskemöjligheter.", lat: 56.05, lon: 14.4667 },
            "Osby": { name: "Osby", activity: "Njut av naturen runt Osbysjön, eller besök Brio Lekoseum.", lat: 56.3667, lon: 13.9833 },
            "Perstorp": { name: "Perstorp", activity: "Utforska den unika Perstorpsparken med dess skulpturer och grönområden.", lat: 56.1333, lon: 13.3833 },
            "Svalöv": { name: "Svalöv", activity: "Besök Svalövs bibliotek, eller utforska de lokala cykellederna i det vackra jordbrukslandskapet.", lat: 55.9142, lon: 13.1044 },
            // Newly added train stations based on search results
            "Barkåkra": { name: "Barkåkra", activity: "Upptäck den charmiga omgivningen och njut av naturen nära stationen.", lat: 56.2995, lon: 12.8718 },
            "Billeberga": { name: "Billeberga", activity: "Upplev det skånska jordbrukslandskapet och den lokala bygden.", lat: 55.8016, lon: 12.9912 },
            "Båstad": { name: "Båstad", activity: "Besök tennisstadion, hamnen eller den vackra strandpromenaden.", lat: 56.4357, lon: 12.8300 },
            "Fjälkinge": { name: "Fjälkinge", activity: "Utforska den lokala bygden och historiska platser i närheten.", lat: 56.0461, lon: 14.2880 },
            "Furulund": { name: "Furulund", activity: "Promenera längs Kävlingeån eller upptäck den lokala naturen.", lat: 55.7599, lon: 13.0487 },
            "Gantofta": { name: "Gantofta", activity: "Njut av de gröna områdena och den lugna atmosfären i byn.", lat: 55.9868, lon: 12.8706 },
            "Glumslöv": { name: "Glumslöv", activity: "Njut av utsikten över Öresund och de böljande fälten.", lat: 55.9328, lon: 12.8647 },
            "Gunnesbo": { name: "Gunnesbo", activity: "Perfekt för att nå de norra delarna av Lund och dess universitetsområde.", lat: 55.7275, lon: 13.1793 },
            "Gärsnäs": { name: "Gärsnäs", activity: "En liten ort på Österlen, känd för sin möbelindustri och charmiga omgivningar.", lat: 55.5398, lon: 14.1685 },
            "Hjärup": { name: "Hjärup", activity: "Upplev småstadscharmen och det vackra landskapet mellan Malmö och Lund.", lat: 55.6791, lon: 13.0805 },
            "Hyllie": { name: "Hyllie", activity: "Besök Emporia köpcentrum eller Malmö Arena, enkelt att nå evenemang.", lat: 55.5684, lon: 12.9839 },
            "Killeberg": { name: "Killeberg", activity: "En lugn plats i norra Skåne, nära till sjöar och skogar.", lat: 56.4172, lon: 13.9880 },
            "Klostergården": { name: "Klostergården", activity: "Utforska grönområdena och sportanläggningarna i närområdet.", lat: 55.6888, lon: 13.1819 },
            "Kvidinge": { name: "Kvidinge", activity: "Utforska den historiska bygden och naturområdena runt Rönne å.", lat: 56.1264, lon: 13.0610 },
            "Köpingebro": { name: "Köpingebro", activity: "En liten ort nära Ystad, med charmiga bymiljöer och omgivande natur.", lat: 55.4223, lon: 13.9015 },
            "Lunnarp": { name: "Lunnarp", activity: "Ett jordbrukslandskap med små byar, perfekt för cykelturer.", lat: 55.5186, lon: 13.9893 },
            "Maria": { name: "Maria", activity: "Ligger nära sjukhuset och bostadsområden i Helsingborg, en bra utgångspunkt för stadens norra delar.", lat: 56.0664, lon: 12.7937 },
            "Marieholm": { name: "Marieholm", activity: "Upptäck den lokala historien och de gröna omgivningarna.", lat: 55.8202, lon: 13.0763 },
            "Mörarp": { name: "Mörarp", activity: "En lugn by med närhet till Helsingborg och vacker natur.", lat: 55.9928, lon: 12.8906 },
            "Oxie": { name: "Oxie", activity: "En lugn förort till Malmö med närhet till både natur och stadsliv.", lat: 55.5492, lon: 13.0906 },
            "Påarp": { name: "Påarp", activity: "En liten ort norr om Helsingborg, idealisk för lugna promenader.", lat: 56.0961, lon: 12.7845 },
            "Ramlösa": { name: "Ramlösa", activity: "Besök den historiska Ramlösa Brunnspark med sina källor och vackra omgivningar.", lat: 56.0270, lon: 12.7562 },
            "Rosengård": { name: "Rosengård", activity: "Utforska de mångkulturella kvarteren och dess unika atmosfär i Malmö.", lat: 55.5891, lon: 13.0305 },
            "Rydsgård": { name: "Rydsgård", activity: "En liten ort med jordbrukslandskap, perfekt för lugna promenader.", lat: 55.4800, lon: 13.4300 },
            "Rydebäck": { name: "Rydebäck", activity: "Kustnära område med fin strand och utsikt över Öresund.", lat: 55.9400, lon: 12.7500 },
            "Skurup": { name: "Skurup", activity: "Besök Skurups folkhögskola eller upptäck den lokala landsbygden.", lat: 55.4819, lon: 13.5681 },
            "Smedstorp": { name: "Smedstorp", activity: "En liten by på Österlen med konst och hantverk i fokus.", lat: 55.5306, lon: 14.1083 },
            "Stångby": { name: "Stångby", activity: "Ett lugnt område norr om Lund, nära till natur och mindre samhällen.", lat: 55.7460, lon: 13.1800 },
            "Svarte": { name: "Svarte", activity: "En liten kustort öster om Ystad, med närhet till havet och stranden.", lat: 55.4055, lon: 13.6738 },
            "Svågertorp": { name: "Svågertorp", activity: "En knutpunkt för handel och transport söder om Malmö.", lat: 55.5583, lon: 12.9861 },
            "Sösdala": { name: "Sösdala", activity: "Nära Finjasjön och dess naturområden, perfekt för utomhusaktiviteter.", lat: 55.8900, lon: 13.6200 },
            "Tjörnarp": { name: "Tjörnarp", activity: "En liten by omgiven av skog och sjöar, perfekt för avkoppling.", lat: 55.9722, lon: 13.6056 },
            "Triangeln": { name: "Triangeln", activity: "Centralt belägen i Malmö, med direkt tillgång till shopping och stadsliv.", lat: 55.5925, lon: 13.0039 },
            "Tyringe": { name: "Tyringe", activity: "Känd för sitt hälsohem, omgiven av vacker natur.", lat: 56.0997, lon: 13.7299 },
            "Ödåkra": { name: "Ödåkra", activity: "En förort till Helsingborg med bra förbindelser och grönområden.", lat: 56.0880, lon: 12.7660 },
            "Östra Grevie": { name: "Östra Grevie", activity: "Utforska den vackra landsbygden runt Vellinge eller besök lokala gårdsbutiker.", lat: 55.5305, lon: 13.0805 }
        };

        // Create stationConnections where each city can reach all other cities
        const stationConnections = {};
        const allCityNames = Object.keys(allCitiesData);
        allCityNames.forEach(startCity => {
            stationConnections[startCity] = allCityNames.filter(destCity => destCity !== startCity);
        });

        const spinButton = document.getElementById('spinButton');
        const startCitySelect = document.getElementById('startCity');
        const destinationDisplay = document.getElementById('destination');
        const activityDisplay = document.getElementById('activity');
        const rouletteDisplayDiv = document.getElementById('rouletteDisplay');
        const trainAnimationContainer = document.getElementById('train-animation-container');
        const trainSVG = document.getElementById('train'); // Reference to the train SVG <g> element
        const loadingIndicator = document.getElementById('loadingIndicator'); // New loading indicator
        const loadingText = document.getElementById('loadingText'); // New element for loading text

        let currentDestinations = []; // Holds the selectable destinations

        // Function to populate the dropdown menu with all start cities
        function populateStartCities() {
            const cities = Object.keys(stationConnections).sort();
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                startCitySelect.appendChild(option);
            });
        }

        // Update the list of destinations based on the selected start city
        function updateDestinations() {
            const selectedStartCity = startCitySelect.value;
            const reachableCityNames = stationConnections[selectedStartCity] || [];

            currentDestinations = reachableCityNames
                .filter(cityName => cityName !== selectedStartCity && allCitiesData[cityName])
                .map(cityName => allCitiesData[cityName]);

            if (currentDestinations.length === 0) {
                spinButton.disabled = true;
                destinationDisplay.textContent = "Inga destinationer hittades från " + selectedStartCity + ".";
                activityDisplay.textContent = "Välj en annan startort.";
            } else {
                spinButton.disabled = false;
                destinationDisplay.textContent = "Slumpa min resa!";
                activityDisplay.textContent = "Välj din startort och klicka för att hitta en destination.";
            }
            // Ensure train is hidden and text is visible after selecting a new city
            trainAnimationContainer.classList.add('hidden');
            trainSVG.style.animationPlayState = 'paused'; // Ensure train is paused
            destinationDisplay.style.display = 'block';
            activityDisplay.style.display = 'block';
            destinationDisplay.style.opacity = '1';
            activityDisplay.style.opacity = '1';
            rouletteDisplayDiv.classList.remove('spinning');
            loadingIndicator.classList.add('hidden'); // Ensure loading indicator is hidden
            loadingText.textContent = "Hittar din position..."; // Reset loading text for next time
        }

        // Function to calculate distance between two geographical points (Haversine formula)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in kilometers
        }

        // Attempt to find the nearest city based on user's location
        function findNearestCity(latitude, longitude) {
            let closestCityName = '';
            let minDistance = Infinity;

            for (const cityName in allCitiesData) {
                const city = allCitiesData[cityName];
                if (city.lat && city.lon) { // Ensure the city has coordinates
                    const distance = haversineDistance(latitude, longitude, city.lat, city.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCityName = cityName;
                    }
                }
            }
            return closestCityName;
        }

        // Function to handle the geolocation result (success or error)
        function handleGeolocationResult(position) {
            loadingIndicator.classList.add('hidden'); // Hide loading indicator
            destinationDisplay.style.display = 'block'; // Show destination/activity text
            activityDisplay.style.display = 'block';

            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const nearestCity = findNearestCity(userLat, userLon);

            if (nearestCity) {
                startCitySelect.value = nearestCity;
                destinationDisplay.textContent = "Din närmaste stad är:";
                activityDisplay.textContent = nearestCity + " (valt automatiskt)";
            } else {
                startCitySelect.value = "Malmö"; // Fallback to Malmö if no city is found
            }
            updateDestinations(); // Update destinations based on selection (or fallback)
            loadingText.textContent = "Hittar din position..."; // Reset loading text for next time
        }

        // Function to handle geolocation errors
        function handleGeolocationError(error) {
            loadingIndicator.classList.add('hidden'); // Hide loading indicator
            destinationDisplay.style.display = 'block'; // Show destination/activity text
            activityDisplay.style.display = 'block';

            console.error("Fel vid hämtning av plats: ", error.message || "Okänt fel vid geolokalisering.");
            startCitySelect.value = "Malmö"; // Fallback to Malmö on error
            updateDestinations(); // Update destinations based on fallback
            loadingText.textContent = "Hittar din position..."; // Reset loading text for next time
        }

        // Initialize the page and try to get user's location
        window.onload = () => {
            populateStartCities(); // Populate dropdown on load
            trainAnimationContainer.classList.add('hidden'); // Ensure the train is hidden on load
            
            // Show loading indicator and hide destination/activity text initially
            loadingIndicator.classList.remove('hidden');
            destinationDisplay.style.display = 'none';
            activityDisplay.style.display = 'none';

            if (navigator.geolocation) {
                const geolocationOptions = {
                    enableHighAccuracy: false, // Prioritize speed over high accuracy
                    maximumAge: 0              // Don't use a cached position older than 0 milliseconds
                };

                // Set a timeout to change the loading text after 5 seconds
                const loadingTextTimeout5Sec = setTimeout(() => {
                    if (!loadingIndicator.classList.contains('hidden')) {
                        loadingText.textContent = "Nästan där...";
                    }
                }, 5000); // 5 seconds

                // Set another timeout to change the loading text after 10 seconds
                const loadingTextTimeout10Sec = setTimeout(() => {
                    if (!loadingIndicator.classList.contains('hidden')) {
                        loadingText.textContent = "Nu går snart tåget...";
                    }
                }, 10000); // 10 seconds

                // Wrap geolocation calls to clear all timeouts
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(loadingTextTimeout5Sec); // Clear 5-sec timeout on success
                        clearTimeout(loadingTextTimeout10Sec); // Clear 10-sec timeout on success
                        handleGeolocationResult(position);
                    },
                    (error) => {
                        clearTimeout(loadingTextTimeout5Sec); // Clear 5-sec timeout on error
                        clearTimeout(loadingTextTimeout10Sec); // Clear 10-sec timeout on error
                        handleGeolocationError(error);
                    },
                    geolocationOptions
                );
            } else {
                // Browser does not support geolocation
                console.log("Webbläsaren stöder inte geolokalisering.");
                handleGeolocationError({ message: "Webbläsaren stöder inte geolokalisering." }); // Call error handler with a message
            }
        };

        // Function to spin the roulette
        function spinRoulette() {
            if (currentDestinations.length === 0) {
                // Custom modal for alert
                const modal = document.createElement('div');
                modal.className = "modal";
                modal.innerHTML = `
                    <div class="modal-content">
                        <p class="mb-4 text-lg font-semibold text-gray-800">Vänligen välj en startort med tillgängliga destinationer.</p>
                        <button id="closeModal" class="bg-purple-700 text-white px-4 py-2 rounded-md hover:bg-purple-800 transition-colors">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                // Trigger transition after adding to DOM
                setTimeout(() => modal.classList.add('show'), 10); 
                document.getElementById('closeModal').addEventListener('click', () => {
                    modal.classList.remove('show');
                    setTimeout(() => document.body.removeChild(modal), 300); // Remove after transition
                });
                return;
            }

            spinButton.disabled = true;
            rouletteDisplayDiv.classList.add('spinning');
            
            // Show train animation and start it
            trainAnimationContainer.classList.remove('hidden');
            trainSVG.style.animationPlayState = 'running';

            // Show destination text and activity text initially, they will rapidly change
            destinationDisplay.style.display = 'block';
            activityDisplay.style.display = 'block';
            destinationDisplay.style.opacity = '0.7'; // Dim during spin
            activityDisplay.style.opacity = '0.7';

            let spinCount = 0;
            const totalSpins = 40; // More spins for a longer, more dramatic effect
            const intervalTime = 80; // Faster interval for rapid changes

            const spinInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * currentDestinations.length);
                const currentSpinningDestination = currentDestinations[randomIndex];

                // Update text content
                destinationDisplay.textContent = currentSpinningDestination.name;
                activityDisplay.textContent = currentSpinningDestination.activity;

                // Apply a subtle scale/fade animation for each step during spin
                destinationDisplay.style.transform = 'scale(1.02)';
                activityDisplay.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    destinationDisplay.style.transform = 'scale(1)';
                    activityDisplay.style.transform = 'scale(1)';
                }, intervalTime / 2); // Half interval for immediate reset

                spinCount++;
                if (spinCount >= totalSpins) {
                    clearInterval(spinInterval);

                    // Stop the train's animation and hide it
                    trainSVG.style.animationPlayState = 'paused';
                    trainAnimationContainer.classList.add('hidden');

                    const finalIndex = Math.floor(Math.random() * currentDestinations.length);
                    const finalDestination = currentDestinations[finalIndex];

                    // Final reveal animation
                    destinationDisplay.textContent = finalDestination.name;
                    activityDisplay.textContent = finalDestination.activity;
                    destinationDisplay.style.opacity = '1'; // Full opacity
                    activityDisplay.style.opacity = '1';

                    destinationDisplay.style.transform = 'scale(0.8)'; // Start smaller
                    activityDisplay.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        destinationDisplay.style.transform = 'scale(1)'; // Pop to normal size
                        activityDisplay.style.transform = 'scale(1)';
                        rouletteDisplayDiv.classList.remove('spinning');
                        spinButton.disabled = false;
                    }, 300); // Small delay for the final pop
                }
            }, intervalTime);
        }

        // Add event listeners for dropdown and button
        startCitySelect.addEventListener('change', updateDestinations);
        spinButton.addEventListener('click', spinRoulette);
    </script>
</body>
</html>
